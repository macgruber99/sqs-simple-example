version: 0.2

phases:
  install:
      runtime-versions:
        python: 3.13
      commands:
        # install Poetry
        - |
          curl -sSL https://install.python-poetry.org | python3 -
          export PATH="/root/.local/bin:$PATH"
        - poetry --version
        # install Terraform
        - |
          TF_VER=$(<terraform/.terraform-version)
          cd /tmp
          curl -fsSL https://releases.hashicorp.com/terraform/${TF_VER}/terraform_${TF_VER}_linux_amd64.zip -o terraform.zip
          unzip terraform.zip
          chmod +x terraform
          mv terraform /usr/local/bin/
          rm terraform.zip
          cd $CODEBUILD_SRC_DIR
        - terraform --version

  pre_build:
    commands:
      - # install Python packages via Poetry
      - |
        echo "Installing Lambda dependencies..."
        for lambda_dir in `find lambdas/ -type d -maxdepth 1 -print | tail -n +2`
        do
          cd ${CODEBUILD_SRC_DIR}/${lambda_dir} && eval $(poetry env activate) && poetry install
          poetry env list
        done

  build:
    commands:
      - # run unit tests
      - # package Lambda function
      - # deploy
      - echo "build phase..."
